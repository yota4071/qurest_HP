name: Preview Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'content/blog/**'
      - 'src/**'
      - 'package*.json'

jobs:
  # ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤
  preview-deploy:
    name: Deploy Preview
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Deploy to Vercel Preview
        uses: amondnet/vercel-action@v25
        id: vercel-preview
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          github-comment: false

      - name: Get changed blog posts
        id: changed-posts
        run: |
          echo "ğŸ“ Checking for new/modified blog posts..."
          CHANGED_POSTS=$(git diff --name-only origin/main...HEAD | grep "content/blog/.*\.md$" || true)
          if [ -n "$CHANGED_POSTS" ]; then
            echo "changed_posts<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_POSTS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "has_blog_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_blog_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment PR with preview
        uses: actions/github-script@v7
        if: steps.changed-posts.outputs.has_blog_changes == 'true'
        with:
          script: |
            const changedPosts = `${{ steps.changed-posts.outputs.changed_posts }}`.split('\n').filter(Boolean);
            const previewUrl = '${{ steps.vercel-preview.outputs.preview-url }}';
            
            let blogLinks = '';
            changedPosts.forEach(post => {
              const slug = post.replace('content/blog/', '').replace('.md', '');
              blogLinks += `- [${slug}](${previewUrl}/blog/${slug})\n`;
            });
            
            const comment = `## ğŸ“ ãƒ–ãƒ­ã‚°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼

            ğŸš€ **ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URL**: ${previewUrl}

            ### æ–°è¦ãƒ»æ›´æ–°ã•ã‚ŒãŸè¨˜äº‹:
            ${blogLinks}

            ### ãƒ–ãƒ­ã‚°ä¸€è¦§:
            [ğŸ“– ãƒ–ãƒ­ã‚°ä¸€è¦§ãƒšãƒ¼ã‚¸](${previewUrl}/blog)

            ---
            _ã“ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯è‡ªå‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚è¨˜äº‹ã®ç¢ºèªå¾Œã€å•é¡ŒãŒãªã‘ã‚Œã°ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚_
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Comment PR without blog changes
        uses: actions/github-script@v7
        if: steps.changed-posts.outputs.has_blog_changes == 'false'
        with:
          script: |
            const previewUrl = '${{ steps.vercel-preview.outputs.preview-url }}';
            
            const comment = `## ğŸ”§ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤

            ğŸš€ **ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URL**: ${previewUrl}

            â„¹ï¸ ã“ã®PRã«ã¯ãƒ–ãƒ­ã‚°è¨˜äº‹ã®å¤‰æ›´ã¯å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

            ---
            _ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã§å‹•ä½œç¢ºèªã‚’è¡Œã£ã¦ãã ã•ã„ã€‚_
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });