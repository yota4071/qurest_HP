name: Preview Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'content/blog/**'
      - 'src/**'
      - 'package*.json'

jobs:
  # プレビューデプロイ
  preview-deploy:
    name: Deploy Preview
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Deploy to Vercel Preview
        uses: amondnet/vercel-action@v25
        id: vercel-preview
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          github-comment: false

      - name: Get changed blog posts
        id: changed-posts
        run: |
          echo "📝 Checking for new/modified blog posts..."
          CHANGED_POSTS=$(git diff --name-only origin/main...HEAD | grep "content/blog/.*\.md$" || true)
          if [ -n "$CHANGED_POSTS" ]; then
            echo "changed_posts<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_POSTS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "has_blog_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_blog_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment PR with preview
        uses: actions/github-script@v7
        if: steps.changed-posts.outputs.has_blog_changes == 'true'
        with:
          script: |
            const changedPosts = `${{ steps.changed-posts.outputs.changed_posts }}`.split('\n').filter(Boolean);
            const previewUrl = '${{ steps.vercel-preview.outputs.preview-url }}';
            
            let blogLinks = '';
            changedPosts.forEach(post => {
              const slug = post.replace('content/blog/', '').replace('.md', '');
              blogLinks += `- [${slug}](${previewUrl}/blog/${slug})\n`;
            });
            
            const comment = `## 📝 ブログプレビュー

            🚀 **プレビューURL**: ${previewUrl}

            ### 新規・更新された記事:
            ${blogLinks}

            ### ブログ一覧:
            [📖 ブログ一覧ページ](${previewUrl}/blog)

            ---
            _このプレビューは自動的に生成されました。記事の確認後、問題がなければマージしてください。_
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Comment PR without blog changes
        uses: actions/github-script@v7
        if: steps.changed-posts.outputs.has_blog_changes == 'false'
        with:
          script: |
            const previewUrl = '${{ steps.vercel-preview.outputs.preview-url }}';
            
            const comment = `## 🔧 プレビューデプロイ

            🚀 **プレビューURL**: ${previewUrl}

            ℹ️ このPRにはブログ記事の変更は含まれていません。

            ---
            _プレビュー環境で動作確認を行ってください。_
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });