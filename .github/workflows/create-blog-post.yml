name: Create Blog Post

on:
  issues:
    types: [opened]

jobs:
  create-blog-post:
    if: contains(github.event.issue.labels.*.name, 'blog')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse issue and create blog post
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs').promises;
            const path = require('path');
            
            // Issue ã®å†…å®¹ã‚’ãƒ‘ãƒ¼ã‚¹
            const issueBody = context.payload.issue.body;
            const title = context.payload.issue.title.replace('[BLOG] ', '');
            
            // ç°¡å˜ãªãƒ‘ãƒ¼ã‚¹ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå®Ÿéš›ã«ã¯ã‚ˆã‚Šè¤‡é›‘ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰
            const parseField = (fieldName) => {
              const regex = new RegExp(`### ${fieldName}\\s*\\n\\n([^#]+)`, 'i');
              const match = issueBody.match(regex);
              return match ? match[1].trim() : '';
            };
            
            const blogTitle = parseField('è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«') || title;
            const author = parseField('è‘—è€…å') || 'QUREST Team';
            const category = parseField('ã‚«ãƒ†ã‚´ãƒª') || 'ãŠçŸ¥ã‚‰ã›';
            const tags = parseField('ã‚¿ã‚°') || '';
            const excerpt = parseField('è¨˜äº‹ã®è¦ç´„') || '';
            const image = parseField('ã‚¢ã‚¤ã‚­ãƒ£ãƒƒãƒç”»åƒ') || '';
            const content = parseField('è¨˜äº‹ã®å†…å®¹') || '';
            
            // ç¾åœ¨ã®æ—¥ä»˜ã‚’å–å¾—
            const now = new Date();
            const dateString = now.toISOString().split('T')[0];
            
            // ãƒ•ã‚¡ã‚¤ãƒ«åç”¨ã®ã‚¹ãƒ©ãƒƒã‚°ã‚’ç”Ÿæˆ
            const slug = blogTitle
              .toLowerCase()
              .replace(/[^\w\s-]/g, '')
              .replace(/\s+/g, '-');
            
            const filename = `${dateString}-${slug}.md`;
            
            // ã‚¿ã‚°ã®é…åˆ—åŒ–
            const tagsArray = tags.split(',').map(tag => tag.trim()).filter(Boolean);
            
            // ãƒ•ãƒ­ãƒ³ãƒˆãƒžã‚¿ãƒ¼ã‚’å«ã‚€ãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆ
            const frontmatter = `---
title: "${blogTitle}"
date: "${dateString}"
author: "${author}"
categories: ["${category}"]
tags: [${tagsArray.map(tag => `"${tag}"`).join(', ')}]${image ? `\nimage: "${image}"` : ''}
excerpt: "${excerpt}"
---

`;
            
            const fullContent = frontmatter + content;
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ã®æ›¸ãè¾¼ã¿
            const blogDir = 'content/blog';
            const filePath = path.join(blogDir, filename);
            
            try {
              await fs.mkdir(blogDir, { recursive: true });
              await fs.writeFile(filePath, fullContent);
              
              console.log(`ãƒ–ãƒ­ã‚°è¨˜äº‹ãŒä½œæˆã•ã‚Œã¾ã—ãŸ: ${filePath}`);
              
              // Issue ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `âœ… ãƒ–ãƒ­ã‚°è¨˜äº‹ãŒè‡ªå‹•ä½œæˆã•ã‚Œã¾ã—ãŸï¼

ðŸ“„ **ãƒ•ã‚¡ã‚¤ãƒ«**: \`${filePath}\`
ðŸ“ **ã‚¿ã‚¤ãƒˆãƒ«**: ${blogTitle}
ðŸ“… **å…¬é–‹æ—¥**: ${dateString}

è¨˜äº‹ã¯ä»¥ä¸‹ã®æ‰‹é †ã§å…¬é–‹ã•ã‚Œã¾ã™ï¼š
1. ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒè‡ªå‹•çš„ã«ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã™
2. ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾Œã€ãƒžãƒ¼ã‚¸ã™ã‚‹ã¨ãƒ–ãƒ­ã‚°ãŒå…¬é–‹ã•ã‚Œã¾ã™

ðŸ”— **ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼**: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒªãƒ³ã‚¯ã§è¨˜äº‹ã‚’ç¢ºèªã§ãã¾ã™`
              });
              
              // æˆåŠŸã‚’workflow output ã«è¨­å®š
              core.setOutput('filename', filename);
              core.setOutput('filepath', filePath);
              
            } catch (error) {
              console.error('ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `âŒ ãƒ–ãƒ­ã‚°è¨˜äº‹ã®è‡ªå‹•ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚

ã‚¨ãƒ©ãƒ¼: ${error.message}

æ‰‹å‹•ã§è¨˜äº‹ã‚’ä½œæˆã™ã‚‹ã‹ã€Issue ã®å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`
              });
              
              throw error;
            }

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Add new blog post: ${{ github.event.issue.title }}"
          title: "ðŸ“ New Blog Post: ${{ github.event.issue.title }}"
          body: |
            ## æ–°ã—ã„ãƒ–ãƒ­ã‚°è¨˜äº‹

            Issue #${{ github.event.issue.number }} ã‹ã‚‰è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚

            ### è¨˜äº‹æƒ…å ±
            - **ã‚¿ã‚¤ãƒˆãƒ«**: ${{ github.event.issue.title }}
            - **ä½œæˆè€…**: @${{ github.event.issue.user.login }}
            - **Issue**: #${{ github.event.issue.number }}

            ### ãƒã‚§ãƒƒã‚¯äº‹é …
            - [ ] è¨˜äº‹ã®å†…å®¹ã‚’ç¢ºèª
            - [ ] ãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®æ›¸å¼ãƒã‚§ãƒƒã‚¯  
            - [ ] ç”»åƒãƒ‘ã‚¹ã®ç¢ºèªï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰
            - [ ] ã‚«ãƒ†ã‚´ãƒªãƒ»ã‚¿ã‚°ã®ç¢ºèª

            ---
            ã“ã®PRã‚’ãƒžãƒ¼ã‚¸ã™ã‚‹ã¨è¨˜äº‹ãŒå…¬é–‹ã•ã‚Œã¾ã™ã€‚
          branch: blog/issue-${{ github.event.issue.number }}
          delete-branch: true

      - name: Close issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸŽ‰ ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸï¼

è¨˜äº‹ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ãƒžãƒ¼ã‚¸ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚ãƒžãƒ¼ã‚¸å¾Œã€è‡ªå‹•çš„ã«Vercelã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚`
            });
            
            await github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              labels: [...context.payload.issue.labels.map(l => l.name), 'auto-processed']
            });